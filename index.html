<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-M-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baby Jumper "Jehee" - Final Version</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: #f0f0f0; }
    canvas {
        background: #d0f4f7;
        display: block;
        height: 100vh; /* ë·°í¬íŠ¸ ë†’ì´ì— ê½‰ ë§ì¶¤ */
        width: auto; /* ë¹„ìœ¨ì— ë”°ë¼ ë„ˆë¹„ ìë™ ì¡°ì ˆ */
        max-width: 100vw; /* ìµœëŒ€ ë„ˆë¹„ëŠ” ë·°í¬íŠ¸ ë„ˆë¹„ë¡œ ì œí•œ */
        aspect-ratio: 4 / 3; /* ë‚´ë¶€ ê²Œì„ í•´ìƒë„(800x600)ì˜ ë¹„ìœ¨ì„ ìœ ì§€ */
        margin: 0 auto; /* ì¤‘ì•™ ì •ë ¬ */
    }
    #uiLayer {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px; /* ê°€ë¡œ ì „ì²´ë¥¼ ì°¨ì§€ */
      display: flex;
      justify-content: space-between; /* ì–‘ìª½ ëìœ¼ë¡œ ì •ë ¬ */
      align-items: flex-start; /* ìƒë‹¨ ì •ë ¬ (ì•„ì´í…œë“¤ì´ ìœ„ì—ì„œë¶€í„° ìŒ“ì´ë„ë¡) */
      color: #0b3c5d;
      font-size: 24px;
      font-weight: bold;
      pointer-events: none;
      z-index: 15; /* ê²Œì„ í™”ë©´ ìœ„ì— ì˜¤ë„ë¡ */
      background-color: transparent; /* ë°°ê²½ ì œê±° */
      padding: 10px 20px;
      border-radius: 10px;
      box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
    }
    #leftUI {
        display: flex;
        flex-direction: column; /* ì„¸ë¡œë¡œ ìŒ“ì´ë„ë¡ ë³€ê²½ */
        gap: 5px; /* Stageì™€ Score ê°„ê²© */
        align-items: flex-start; /* ì™¼ìª½ ì •ë ¬ */
    }
    #rightUI {
        display: flex;
        flex-direction: column; /* ì„¸ë¡œë¡œ ìŒ“ì´ë„ë¡ ë³€ê²½ */
        gap: 5px; /* ëª©ìˆ¨, ì‹œê°„, ë²„ë¸” ê°¯ìˆ˜ ê°„ê²© */
        align-items: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
    }
    /* Bubble Gaugeë¥¼ rightUI ì•ˆì— ë°°ì¹˜í•˜ë©´ì„œ ìŠ¤íƒ€ì¼ ì¡°ì • */
    #bubbleGauge {
        display: flex;
        gap: 5px;
        align-items: center;
        z-index: 15;
        background-color: transparent; /* ë°°ê²½ ì œê±° */
        padding: 0; /* íŒ¨ë”© ì œê±° */
        box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
        margin-top: 10px; /* ì‹œê°„ ì•„ë˜ë¡œ ì•½ê°„ì˜ ê°„ê²© */
    }

    .bubble-icon { width: 30px; height: 30px; opacity: 1; transition: opacity 0.2s; }
    .bubble-icon.empty { opacity: 0.2; }

    #startScreen, #winScreen, #gameOverScreen {
      position: absolute; width: 100%; height: 100%;
      background: linear-gradient(to bottom, #a8e0f7, #d9f7fc);
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; z-index: 10; text-align: center;
    }
    #gameOverScreen { background: linear-gradient(to bottom, #5c5c5c, #333333); }
    #startScreen h1, #winScreen h1, #gameOverScreen h1 { font-size: 64px; color: #ff9f1c; margin-bottom: 20px; }
    #gameOverScreen h1 { color: #ff4d6d; }
    #startScreen p, #winScreen p, #gameOverScreen p { font-size: 20px; color: #3282b8; margin-bottom: 30px; }
    #gameOverScreen p { color: #cccccc; }
    #startButton, #restartButton, #restartButtonGO {
      padding: 15px 40px; font-size: 24px;
      background-color: #ff9f1c; color: white;
      border: 2px solid #e68a00; border-radius: 12px; cursor: pointer;
      box-shadow: 0 4px #e68a00;
    }
    .rankingList {
      font-size: 18px; color: #333; margin: 20px 0; text-align: left;
      background: white; padding: 15px; border-radius: 10px; width: 300px;
    }
    .rankingList h3 { margin-top: 0; text-align: center;}

    /* [ëª¨ë°”ì¼] í„°ì¹˜ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #mobileControls {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 120px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-sizing: border-box;
        padding: 20px;
        z-index: 20;
        user-select: none;
    }
    /* ì¢Œìš° ì´ë™ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ìƒˆë¡œìš´ div */
    #moveBtns {
        display: flex;
        gap: 5px; /* ì¢Œìš° ì´ë™ ë²„íŠ¼ ê°„ ê°„ê²© ìµœì†Œí™” */
    }
    #actionBtns {
        display: flex;
        gap: 20px; /* ì•¡ì…˜ ë²„íŠ¼ ê°„ ê°„ê²© ìœ ì§€ */
    }

    #leftBtn, #rightBtn, #jumpBtn, #bubbleJumpBtn {
        width: 70px;
        height: 70px;
        background-color: rgba(255, 159, 28, 0.7);
        color: white;
        font-size: 24px;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        border: 3px solid rgba(230, 138, 0, 0.9);
        box-shadow: 0 4px rgba(230, 138, 0, 0.9);
    }


    /* ì„¸ë¡œ ëª¨ë“œì¼ ë•Œ ë³´ì—¬ì¤„ ì•Œë¦¼ (ê¸°ë³¸ì ìœ¼ë¡œëŠ” ìˆ¨ê¹€) */
    #orientation-alert {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      font-size: 28px;
      text-align: center;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }

    #orientation-alert img {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        /* rotate_icon.pngì— ë”°ë¼ í•„ìš” ì—†ìœ¼ë©´ ì œê±° */
        /* transform: rotate(90deg); */
    }

    /* ê°€ë¡œ ëª¨ë“œì¼ ë•Œ #orientation-alertë¥¼ ìˆ¨ê¹€ */
    @media screen and (orientation: landscape) {
      #orientation-alert {
        display: none;
      }
      /* ê°€ë¡œ ëª¨ë“œì¼ ë•Œ ê²Œì„ê³¼ ë‹¤ë¥¸ UIë¥¼ í‘œì‹œ */
      #gameCanvas {
        display: block;
      }
      #uiLayer, #mobileControls {
        display: flex;
      }
    }

    /* ì„¸ë¡œ ëª¨ë“œì¼ ë•Œ ê²Œì„ ê´€ë ¨ UI ìˆ¨ê¹€ */
    @media screen and (orientation: portrait) {
      #gameCanvas, #uiLayer, #bubbleGauge, #mobileControls,
      #startScreen, #winScreen, #gameOverScreen {
        display: none !important;
      }
      #orientation-alert {
        display: flex;
      }
    }

    /* ì´ˆê¸° ë¡œë”© ì‹œ startScreenë§Œ ë³´ì´ë„ë¡ ì„¤ì • (ë‹¤ë¥¸ í™”ë©´ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì§) */
    #startScreen { display: flex; }
    #winScreen, #gameOverScreen { display: none; }
    #uiLayer, #bubbleGauge, #mobileControls, #gameCanvas { display: none; }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>Baby Jumper "Jehee"</h1>
    <p>5ê°œì˜ ë²„ë¸”ë¡œ 20ê°œì˜ ìŠ¤í…Œì´ì§€ë¥¼ ì •ë³µí•˜ì„¸ìš”!</p>
    <p><strong>Controls:</strong> â† â†’ to move, A to Jump, SPACE to Bubble Jump</p>
    <button id="startButton" disabled>ê²Œì„ ë¡œë”©ì¤‘...</button>
  </div>

  <div id="winScreen">
    <h1>CONGRATULATIONS!</h1>
    <p>ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</p>
    <div id="rankingList" class="rankingList"></div>
    <button id="restartButton">Play Again</button>
  </div>

  <div id="gameOverScreen">
    <h1>GAME OVER</h1>
    <p>í˜„ì¬ ìŠ¤ì½”ì–´ : <span id="finalScoreGO"></span></p>
    <div id="rankingListGO" class="rankingList"></div>
    <button id="restartButtonGO">Try Again</button>
  </div>

  <div id="uiLayer">
    <div id="leftUI">
      <div id="stageDisplay">Stage 1</div>
      <div id="score">Score: 0</div>
    </div>
    <div id="rightUI">
      <div id="livesDisplay">â¤ï¸ 3</div>
      <div id="timerDisplay">â° 20</div>
      <div id="bubbleGauge"></div>
    </div>
  </div>

  <canvas id="gameCanvas"></canvas>
  <audio id="bgm" src="./bgm.mpm" loop></audio>

  <div id="mobileControls">
    <div id="moveBtns">
      <div id="leftBtn">â†</div>
      <div id="rightBtn">â†’</div>
    </div>
    <div id="actionBtns">
      <div id="bubbleJumpBtn">BUBBLE</div>
      <div id="jumpBtn">JUMP</div>
    </div>
  </div>

  <div id="orientation-alert">
    <img src="./rotate_icon.png" alt="Rotate to Landscape Mode">
    <p>ê°€ë¡œ ëª¨ë“œë¡œ ì „í™˜í•´ ì£¼ì„¸ìš”.</p>
    <p>(Please switch to landscape mode)</p>
  </div>


  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800; canvas.height = 600;

    // worldHeightëŠ” ìŠ¤í…Œì´ì§€ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
    let worldHeight = canvas.height * 2; 

    const camera = {
      y: worldHeight - canvas.height,
      lerpFactor: 0.08
    };

    const babyImg = new Image(); babyImg.src = "./baby.png";
    const platformImg = new Image(); platformImg.src = "./platform.png";
    const bubbleImg = new Image(); bubbleImg.src = "./bubble.png";
    const goalImg = new Image(); goalImg.src = "./milk.png";
    const dragonImg = new Image(); dragonImg.src = "./dragon.png";
    // ìƒˆë¡œìš´ ì  ì´ë¯¸ì§€ ì¶”ê°€
    const redDragonImg = new Image(); redDragonImg.src = "./reddragon.png";
    const goldDragonImg = new Image(); goldDragonImg.src = "./golddragon.png";

    const bgm = document.getElementById('bgm');

    let gameStarted = false, score = 0;
    let currentStage = 1;
    const totalStages = 20; // ì´ ìŠ¤í…Œì´ì§€ ìˆ˜ 20ìœ¼ë¡œ ë³€ê²½
    let stageTimer = 20;
    let lastTime = 0, deltaTime = 0;

    const baby = {
      x: canvas.width / 2 - 25, y: worldHeight - 80, // ì´ˆê¸° worldHeightëŠ” í˜„ì¬ ìŠ¤í…Œì´ì§€ì— ë”°ë¼ ê²°ì •
      width: 50, height: 50, speed: 4,
      dx: 0, dy: 0, gravity: 0.4, jumpPower: -10,
      isJumping: false, bubblesLeft: 5, maxBubbles: 5, bubbleJumpPower: -12,
      lives: 3
    };
    const platforms = [], playerBubbles = [], enemies = [], enemyBubbles = []; // playerBubblesë¡œ ì´ë¦„ ë³€ê²½, enemyBubbles ì¶”ê°€
    const goal = { x: canvas.width / 2 - 20, y: 50, width: 40, height: 40 };

    // ìŠ¤í…Œì´ì§€ ì„¤ì • ì—…ë°ì´íŠ¸: totalStagesë¥¼ 20ìœ¼ë¡œ ëŠ˜ë¦¬ê³ , redDragon, goldDragon ì†ì„± ì¶”ê°€
    const stageConfigs = [
        { stage: 1, normal: 0, fast: 0, jumper: 0, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 2, normal: 1, fast: 0, jumper: 0, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 3, normal: 2, fast: 0, jumper: 0, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 4, normal: 3, fast: 0, jumper: 0, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 5, normal: 4, fast: 0, jumper: 0, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 6, normal: 3, fast: 2, jumper: 0, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 7, normal: 3, fast: 2, jumper: 1, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 8, normal: 7, fast: 2, jumper: 1, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 9, normal: 6, fast: 4, jumper: 2, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        { stage: 10, normal: 4, fast: 8, jumper: 3, redDragon: 0, goldDragon: 0, lengthMultiplier: 1 },
        // 11 ìŠ¤í…Œì´ì§€ë¶€í„° ì¶”ê°€ ì„¤ì •
        { stage: 11, normal: 4, fast: 10, jumper: 3, redDragon: 3, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 12, normal: 3, fast: 12, jumper: 5, redDragon: 5, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 13, normal: 3, fast: 12, jumper: 5, redDragon: 0, goldDragon: 1, lengthMultiplier: 1.5 }, // reddragon ê°œìˆ˜ ì¡°ì • í•„ìš” (1ë§ˆë¦¬ golddragon ì¶œí˜„)
        { stage: 14, normal: 3, fast: 12, jumper: 5, redDragon: 3, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 15, normal: 3, fast: 12, jumper: 5, redDragon: 5, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 16, normal: 3, fast: 12, jumper: 6, redDragon: 7, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 17, normal: 3, fast: 12, jumper: 6, redDragon: 10, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 18, normal: 5, fast: 15, jumper: 6, redDragon: 10, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 19, normal: 5, fast: 17, jumper: 8, redDragon: 12, goldDragon: 0, lengthMultiplier: 1.5 },
        { stage: 20, normal: 0, fast: 17, jumper: 8, redDragon: 12, goldDragon: 1, lengthMultiplier: 1.5 } // ê³¨ë“œ ë“œë˜ê³¤ ìµœì¢… ë³´ìŠ¤
    ];

    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');
    const restartButtonGO = document.getElementById('restartButtonGO');
    const startScreen = document.getElementById('startScreen');
    const winScreen = document.getElementById('winScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const stageDisplay = document.getElementById('stageDisplay');
    const scoreText = document.getElementById('score');
    const bubbleGauge = document.getElementById('bubbleGauge');
    const livesDisplay = document.getElementById('livesDisplay');
    const timerDisplay = document.getElementById('timerDisplay');
    const rankingList = document.getElementById('rankingList');
    const rankingListGO = document.getElementById('rankingListGO');
    const orientationAlert = document.getElementById('orientation-alert');
    const finalScoreGO = document.getElementById('finalScoreGO');

    function enterFullscreen() {
        const elem = document.documentElement;
        if (elem.requestFullscreen) {
            elem.requestFullscreen();
        } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
        } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
        } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
        }
    }

    function checkOrientation() {
        if (window.innerWidth < window.innerHeight) {
            document.getElementById('gameCanvas').style.display = 'none';
            document.getElementById('uiLayer').style.display = 'none';
            document.getElementById('bubbleGauge').style.display = 'none';
            document.getElementById('mobileControls').style.display = 'none';
            startScreen.style.display = 'none';
            winScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';

            orientationAlert.style.display = 'flex';
            gameStarted = false;
            bgm.pause();
        } else {
            orientationAlert.style.display = 'none';

            if (gameStarted) {
                document.getElementById('gameCanvas').style.display = 'block';
                document.getElementById('uiLayer').style.display = 'flex';
                document.getElementById('bubbleGauge').style.display = 'flex';
                setupMobileControls();
                update();
                bgm.play().catch(e => console.log("BGM ì¬ìƒ ì˜¤ë¥˜:", e));
                winScreen.style.display = 'none';
                gameOverScreen.style.display = 'none';
            } else {
                document.getElementById('gameCanvas').style.display = 'none';
                document.getElementById('uiLayer').style.display = 'none';
                document.getElementById('bubbleGauge').style.display = 'none';
                document.getElementById('mobileControls').style.display = 'none';

                if (gameOverScreen.style.display !== 'none') {
                    gameOverScreen.style.display = 'flex';
                } else if (winScreen.style.display !== 'none') {
                    winScreen.style.display = 'flex';
                } else {
                    startScreen.style.display = 'flex';
                }
            }
        }
    }

    window.addEventListener('resize', checkOrientation);

    function generateLevel() {
      platforms.length = 0; enemies.length = 0; enemyBubbles.length = 0; // ì  ë²„ë¸” ì´ˆê¸°í™”
      
      const config = stageConfigs[currentStage - 1];
      if (!config) return;

      // ìŠ¤í…Œì´ì§€ ê¸¸ì´ì— ë”°ë¼ worldHeight ì„¤ì •
      worldHeight = canvas.height * 2 * config.lengthMultiplier;
      camera.y = worldHeight - canvas.height; // ì¹´ë©”ë¼ ì´ˆê¸° ìœ„ì¹˜ ì¬ì„¤ì •

      // ë°”ë‹¥ í”Œë«í¼ ì¶”ê°€
      platforms.push({ x: 0, y: worldHeight - 20, width: canvas.width });
      
      let currentY = worldHeight - 100;
      // ìŠ¤í…Œì´ì§€ ê¸¸ì´ì— ë¹„ë¡€í•˜ì—¬ í”Œë«í¼ ìƒì„±
      while (currentY > 100 + (worldHeight - canvas.height * 2) / 2) { // ìƒë‹¨ ë¶€ë¶„ì€ ì¼ì •í•˜ê²Œ ìœ ì§€
        let pWidth = 100 + Math.random() * 50;
        let pX = Math.random() * (canvas.width - pWidth);
        platforms.push({ x: pX, y: currentY, width: pWidth });
        currentY -= 70 + Math.random() * 50; // í”Œë«í¼ ê°„ê²©
      }

      const spawnPlatforms = [...platforms].slice(1); // ë°”ë‹¥ í”Œë«í¼ ì œì™¸
      spawnPlatforms.sort(() => 0.5 - Math.random());
      let platformIndex = 0;

      const createEnemy = (type, isBoss = false) => {
          let platform;
          if (isBoss) { // ë³´ìŠ¤ëŠ” ìµœìƒë‹¨ í”Œë«í¼ ê·¼ì²˜ì— ë°°ì¹˜
              const topPlatform = platforms.reduce((prev, curr) => (curr.y < prev.y ? curr : prev), platforms[0]);
              platform = topPlatform;
          } else { // ì¼ë°˜ ì ì€ ëœë¤ í”Œë«í¼
              if (spawnPlatforms.length === 0) return;
              platform = spawnPlatforms[platformIndex % spawnPlatforms.length];
              platformIndex++;
          }
          
          let enemyWidth = 35;
          let enemyHeight = 35;
          let enemySpeed = 1 + Math.random() * currentStage * 0.15;
          let jumpPower = -7 - Math.random() * 2;
          let image = dragonImg;
          let shootInterval = 0; // ë²„ë¸” ë°œì‚¬ ê°„ê²©

          if (type === 'fast') { enemySpeed *= 2; }
          if (type === 'jumper') { enemySpeed = 0; }
          if (type === 'redDragon') { 
            image = redDragonImg; 
            shootInterval = 1000 + Math.random() * 1500; // 1~2.5ì´ˆë§ˆë‹¤ ë²„ë¸” ë°œì‚¬
          }
          if (type === 'goldDragon') {
            image = goldDragonImg;
            enemyWidth *= 2; // ê°€ë¡œ 2ë°°
            enemyHeight *= 2; // ì„¸ë¡œ 2ë°°
            enemySpeed = 1; // ì¼ë°˜ ìŠ¤í”¼ë“œ ìœ ì§€
            shootInterval = 800 + Math.random() * 1200; // 0.8~2ì´ˆë§ˆë‹¤ ë²„ë¸” ë°œì‚¬
          }


          enemies.push({
              x: platform.x + platform.width / 2 - enemyWidth / 2, 
              y: platform.y - enemyHeight, 
              width: enemyWidth, 
              height: enemyHeight,
              direction: Math.random() < 0.5 ? 1 : -1, 
              type: type,
              speed: enemySpeed,
              dy: 0, 
              groundY: platform.y - enemyHeight, 
              jumpPower: jumpPower,
              image: image,
              lastShotTime: 0,
              shootInterval: shootInterval
          });
      };

      // ìŠ¤í…Œì´ì§€ ì„¤ì •ì— ë”°ë¼ ì  ìƒì„±
      for(let i=0; i<config.normal; i++) createEnemy('normal');
      for(let i=0; i<config.fast; i++) createEnemy('fast');
      for(let i=0; i<config.jumper; i++) createEnemy('jumper');
      for(let i=0; i<config.redDragon; i++) createEnemy('redDragon');
      // ê³¨ë“œ ë“œë˜ê³¤ì€ 20ìŠ¤í…Œì´ì§€ì—ì„œë§Œ, ê·¸ë¦¬ê³  í•˜ë‚˜ë§Œ ìƒì„±
      if (config.goldDragon > 0 && currentStage === 20) {
          createEnemy('goldDragon', true); // isBoss = true
      }
      
      const topPlatform = platforms.reduce((prev, curr) => (curr.y < prev.y ? curr : prev), platforms[0]);
      goal.x = topPlatform.x + (topPlatform.width / 2) - (goal.width / 2);
      goal.y = topPlatform.y - goal.height - 15;
    }

    function startGame() {
      startScreen.style.display = 'none';
      winScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';
      document.getElementById('gameCanvas').style.display = 'block';
      document.getElementById('uiLayer').style.display = 'flex';
      document.getElementById('bubbleGauge').style.display = 'flex';
      setupMobileControls();

      gameStarted = true; score = 0; currentStage = 1; baby.lives = 3;
      generateLevel();
      resetPlayerPosition(); // resetPlayerPositionì—ì„œ worldHeight ì¬ì„¤ì •
      bgm.currentTime = 0; bgm.play().catch(e => console.log("BGM ì¬ìƒ ì˜¤ë¥˜:", e));
      update();
      enterFullscreen();
    }
    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', startGame);
    restartButtonGO.addEventListener('click', startGame);

    function resetPlayerPosition() {
        stageTimer = 20; 
        
        // í˜„ì¬ ìŠ¤í…Œì´ì§€ì— ë§ëŠ” worldHeight ì„¤ì •
        const config = stageConfigs[currentStage - 1];
        if (config) {
            worldHeight = canvas.height * 2 * config.lengthMultiplier;
        } else {
            worldHeight = canvas.height * 2; // ê¸°ë³¸ê°’
        }

        baby.x = canvas.width / 2 - 25; 
        baby.y = worldHeight - 80; // ì¬ì„¤ì •ëœ worldHeightì— ë§ì¶° í”Œë ˆì´ì–´ ìœ„ì¹˜ ì¡°ì •
        baby.dy = 0; 
        camera.y = worldHeight - canvas.height; // ì¹´ë©”ë¼ ìœ„ì¹˜ë„ ì¬ì„¤ì •
        baby.bubblesLeft = baby.maxBubbles;
        enemies.length = 0; // ì  ì´ˆê¸°í™”
        enemyBubbles.length = 0; // ì  ë²„ë¸” ì´ˆê¸°í™”
        generateLevel(); // ìƒˆ ë ˆë²¨ ìƒì„±
    }

    function handleLoseLife() {
        baby.lives--;
        if (baby.lives <= 0) {
            showGameOver();
        } else {
            resetPlayerPosition();
        }
    }

    function updateAndShowRanking(playerName, targetElement) {
        let scores = JSON.parse(localStorage.getItem('babyJumperScores')) || [];
        scores.push({ name: playerName, score: score });
        scores.sort((a, b) => b.score - a.score);
        scores = scores.slice(0, 5);
        localStorage.setItem('babyJumperScores', JSON.stringify(scores));
        let rankingHtml = '<h3>ğŸ† Top 5 Scores ğŸ†</h3><ol>';
        rankingHtml += scores.map(s => `<li>${s.name}: ${s.score}</li>`).join('');
        rankingHtml += '</ol>';
        targetElement.innerHTML = rankingHtml;
    }

    function showGameOver() {
        gameStarted = false;
        bgm.pause();
        document.getElementById('gameCanvas').style.display = 'none';
        document.getElementById('uiLayer').style.display = 'none';
        document.getElementById('bubbleGauge').style.display = 'none';
        document.getElementById('mobileControls').style.display = 'none';

        finalScoreGO.textContent = score;

        const playerName = prompt(`GAME OVER!\nYour Score: ${score}\n\nEnter your name for the ranking:`, "AAA");
        updateAndShowRanking(playerName || "Guest", rankingListGO);
        gameOverScreen.style.display = 'flex';
    }

    function advanceToNextStage() {
        score += Math.ceil(stageTimer * 10);

        if (currentStage === totalStages) { // ë§ˆì§€ë§‰ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ë³´ë„ˆìŠ¤
            score += 300;
            score += baby.lives * 100;
        }

        currentStage++;
        if (currentStage > totalStages) {
            showWinScreen();
        } else {
            resetPlayerPosition(); // ìƒˆ ìŠ¤í…Œì´ì§€ë¥¼ ìœ„í•´ í”Œë ˆì´ì–´ ìœ„ì¹˜ ì´ˆê¸°í™” ë° ë ˆë²¨ ìƒì„±
        }
    }

    function showWinScreen() {
        gameStarted = false;
        bgm.pause();
        document.getElementById('gameCanvas').style.display = 'none';
        document.getElementById('uiLayer').style.display = 'none';
        document.getElementById('bubbleGauge').style.display = 'none';
        document.getElementById('mobileControls').style.display = 'none';

        const playerName = prompt(`CONGRATULATIONS!\nYour Final Score: ${score}\n\nEnter your name for the ranking:`, "ACE");
        updateAndShowRanking(playerName || "Guest", rankingList);
        winScreen.style.display = 'flex';
    }

    function bubbleJump() {
      if (baby.bubblesLeft > 0 && gameStarted) {
        baby.bubblesLeft--; 
        baby.dy = baby.bubbleJumpPower;
        // í”Œë ˆì´ì–´ ë²„ë¸”: x, y, radius, life, (dx, dyëŠ” í•„ìš”ì‹œ ì¶”ê°€)
        playerBubbles.push({x: baby.x + baby.width / 2, y: baby.y + baby.height, radius: 15, life: 30});
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.save();
      ctx.translate(0, -camera.y);

      // ë°°ê²½ìƒ‰ ê·¸ë¦¬ê¸° (worldHeightì— ë”°ë¼)
      ctx.fillStyle = '#d0f4f7';
      ctx.fillRect(0, 0, canvas.width, worldHeight);

      platforms.forEach(p => ctx.drawImage(platformImg, p.x, p.y, p.width, 20));
      
      ctx.filter = 'sepia(1) saturate(10) hue-rotate(-50deg) brightness(1.1)';
      ctx.drawImage(goalImg, goal.x, goal.y, goal.width, goal.height);
      ctx.filter = 'none';
      
      // ì  ê·¸ë¦¬ê¸° (ê° ì ì˜ ì´ë¯¸ì§€ ì‚¬ìš©)
      enemies.forEach(e => {
        ctx.drawImage(e.image, e.x, e.y, e.width, e.height);
      });

      ctx.drawImage(babyImg, baby.x, baby.y, baby.width, baby.height);
      
      // í”Œë ˆì´ì–´ ë²„ë¸” ê·¸ë¦¬ê¸°
      playerBubbles.forEach((b, index) => {
        b.y += 2; b.radius *= 0.95; b.life--;
        ctx.globalAlpha = b.life / 30;
        ctx.drawImage(bubbleImg, b.x - b.radius, b.y - b.radius, b.radius * 2, b.radius * 2);
        if (b.life <= 0) playerBubbles.splice(index, 1);
      });

      // ì  ë²„ë¸” ê·¸ë¦¬ê¸°
      enemyBubbles.forEach((b, index) => {
        b.x += b.dx;
        b.y += b.dy;
        b.life--;
        ctx.globalAlpha = b.life / 60; // ì  ë²„ë¸”ì€ ì¢€ ë” ì˜¤ë˜ ìœ ì§€
        ctx.drawImage(bubbleImg, b.x - b.radius, b.y - b.radius, b.radius * 2, b.radius * 2);
        if (b.life <= 0) enemyBubbles.splice(index, 1);
      });

      ctx.globalAlpha = 1;
      ctx.restore();
    }

    function drawUI() {
        stageDisplay.textContent = `Stage ${currentStage} / ${totalStages}`; // ì´ ìŠ¤í…Œì´ì§€ ìˆ˜ í‘œì‹œ
        scoreText.textContent = `Score: ${score}`;
        livesDisplay.textContent = 'â¤ï¸ ' + baby.lives;
        timerDisplay.textContent = 'â° ' + Math.ceil(stageTimer);
        bubbleGauge.innerHTML = '';
        for(let i = 0; i < baby.maxBubbles; i++) {
            const img = document.createElement('img');
            img.src = './bubble.png';
            img.className = 'bubble-icon';
            if (i >= baby.bubblesLeft) img.classList.add('empty');
            bubbleGauge.appendChild(img);
        }
    }

    function update(time = 0) {
      if (!gameStarted || window.innerWidth < window.innerHeight) return;
      deltaTime = (time - lastTime) / 1000; lastTime = time;
      stageTimer -= deltaTime;
      if (stageTimer <= 0) { handleLoseLife(); }

      // í”Œë ˆì´ì–´ ì´ë™ ë° ë¬¼ë¦¬
      baby.x += baby.dx; 
      baby.dy += baby.gravity; 
      baby.y += baby.dy;

      // ì¹´ë©”ë¼ ì—…ë°ì´íŠ¸
      const cameraTargetY = baby.y - canvas.height / 2;
      camera.y += (cameraTargetY - camera.y) * camera.lerpFactor;
      if (camera.y < 0) camera.y = 0;
      // ì¹´ë©”ë¼ê°€ worldHeight ëì„ ë„˜ì§€ ì•Šë„ë¡
      if (camera.y > worldHeight - canvas.height) { camera.y = worldHeight - canvas.height; }

      // í”Œë ˆì´ì–´ í™”ë©´ ê²½ê³„ ì²˜ë¦¬
      if (baby.x < 0) baby.x = 0;
      if (baby.x + baby.width > canvas.width) baby.x = canvas.width - baby.width;

      // í”Œë ˆì´ì–´ í”Œë«í¼ ì¶©ëŒ ì²˜ë¦¬
      if (baby.dy > 0) { // í•˜ê°• ì¤‘ì¼ ë•Œë§Œ ì¶©ëŒ ê²€ì‚¬
        platforms.forEach(p => {
          if (baby.x + baby.width > p.x && baby.x < p.x + p.width &&
              baby.y + baby.height > p.y && baby.y < p.y + 20) { // í”Œë«í¼ ë†’ì´ 20
            baby.y = p.y - baby.height; 
            baby.dy = 0; 
            baby.isJumping = false;
          }
        });
      }

      // ì  ì—…ë°ì´íŠ¸ ë° ì¶©ëŒ ì²˜ë¦¬
      enemies.forEach(e => {
        switch(e.type) {
            case 'normal': 
            case 'fast':
                e.x += e.speed * e.direction;
                if(e.x < 0 || e.x + e.width > canvas.width) e.direction *= -1;
                break;
            case 'jumper':
                e.dy += baby.gravity * 0.5; // ì í¼ ì ì€ ì¤‘ë ¥ ì˜í–¥ì„ ë” ì ê²Œ ë°›ìŒ
                e.y += e.dy;
                // ë•…ì— ë‹¿ìœ¼ë©´ ì í”„
                if (e.y > e.groundY && e.dy > 0) { 
                    e.y = e.groundY; 
                    e.dy = e.jumpPower; 
                }
                break;
            case 'redDragon':
            case 'goldDragon':
                // ë ˆë“œ/ê³¨ë“œ ë“œë˜ê³¤ì€ ì¢Œìš° ì´ë™
                e.x += e.speed * e.direction;
                if(e.x < 0 || e.x + e.width > canvas.width) e.direction *= -1;

                // ë²„ë¸” ë°œì‚¬ ë¡œì§
                if (time - e.lastShotTime > e.shootInterval) {
                    const bubbleRadius = (e.type === 'goldDragon') ? 30 : 15; // ê³¨ë“œ ë“œë˜ê³¤ ë²„ë¸” 2ë°° í¬ê¸°
                    const bubbleLife = (e.type === 'goldDragon') ? 120 : 60; // ê³¨ë“œ ë“œë˜ê³¤ ë²„ë¸” ë” ì˜¤ë˜ ìœ ì§€
                    const bubbleSpeed = (e.type === 'goldDragon') ? 1.5 : 2; // ë²„ë¸” ì†ë„
                    
                    const angle = Math.atan2(baby.y + baby.height / 2 - (e.y + e.height / 2), baby.x + baby.width / 2 - (e.x + e.width / 2));
                    enemyBubbles.push({
                        x: e.x + e.width / 2, 
                        y: e.y + e.height / 2, 
                        radius: bubbleRadius, 
                        life: bubbleLife,
                        dx: Math.cos(angle) * bubbleSpeed,
                        dy: Math.sin(angle) * bubbleSpeed
                    });
                    e.lastShotTime = time;
                }
                break;
        }

        // í”Œë ˆì´ì–´ì™€ ì  ì¶©ëŒ
        if (baby.x < e.x + e.width && baby.x + baby.width > e.x &&
            baby.y < e.y + e.height && baby.y + baby.height > e.y) {
            handleLoseLife();
        }
      });

      // ì  ë²„ë¸” ì—…ë°ì´íŠ¸ ë° í”Œë ˆì´ì–´ì™€ ì¶©ëŒ ì²˜ë¦¬
      enemyBubbles.forEach((b, index) => {
          b.x += b.dx;
          b.y += b.dy;
          b.life--;

          // í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ë©´ ì œê±°
          if (b.x < -b.radius || b.x > canvas.width + b.radius || b.y < -b.radius || b.y > worldHeight + b.radius || b.life <= 0) {
              enemyBubbles.splice(index, 1);
              return; // í˜„ì¬ ë²„ë¸” ì œê±° í›„ ë‹¤ìŒ ë²„ë¸”ë¡œ ì´ë™
          }

          // í”Œë ˆì´ì–´ì™€ ë²„ë¸” ì¶©ëŒ
          if (baby.x < b.x + b.radius && baby.x + baby.width > b.x - b.radius &&
              baby.y < b.y + b.radius && baby.y + baby.height > b.y - b.radius) {
              handleLoseLife();
              enemyBubbles.splice(index, 1); // ì¶©ëŒí•œ ë²„ë¸” ì œê±°
          }
      });


      // í”Œë ˆì´ì–´ ë‚™ì‚¬ ì²˜ë¦¬ (worldHeightë³´ë‹¤ ì•„ë˜ë¡œ ë–¨ì–´ì§ˆ ê²½ìš°)
      if (baby.y > worldHeight) { handleLoseLife(); }
      // í”Œë ˆì´ì–´ê°€ í™”ë©´ ìƒë‹¨ìœ¼ë¡œ ë„ˆë¬´ ë†’ì´ ì˜¬ë¼ê°ˆ ê²½ìš° ì²˜ë¦¬ (worldHeightëŠ” ìƒë‹¨ì´ 0)
      if (baby.y + baby.height < 0) { 
        baby.y = -baby.height; 
        baby.dy = 1; 
      } // í”Œë ˆì´ì–´ê°€ ë„ˆë¬´ ë†’ì´ ì˜¬ë¼ê°”ì„ ë•Œ ë‹¤ì‹œ ë‚´ë ¤ì˜¤ë„ë¡

      // ëª©í‘œ ì§€ì  ë„ë‹¬ ì—¬ë¶€ í™•ì¸
      if (baby.x < goal.x + goal.width && baby.x + baby.width > goal.x &&
          baby.y < goal.y + goal.height && baby.y + baby.height > goal.y) {
        advanceToNextStage();
      }
      
      draw();
      drawUI();
      requestAnimationFrame(update);
    }

    // [ëª¨ë°”ì¼] í„°ì¹˜ ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§
    function setupMobileControls() {
        const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const mobileControlsDiv = document.getElementById('mobileControls');
        if (!isMobile) {
            mobileControlsDiv.style.display = 'none';
            return;
        }
        // ê°€ë¡œ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ
        if (window.innerWidth < window.innerHeight) {
            mobileControlsDiv.style.display = 'none';
        } else {
            mobileControlsDiv.style.display = 'flex';
        }

        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');
        const bubbleJumpBtn = document.getElementById('bubbleJumpBtn');

        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
        leftBtn.removeEventListener('touchstart', handleLeftTouchStart);
        leftBtn.removeEventListener('touchend', handleLeftTouchEnd);
        rightBtn.removeEventListener('touchstart', handleRightTouchStart);
        rightBtn.removeEventListener('touchend', handleRightTouchEnd);
        jumpBtn.removeEventListener('touchstart', handleJumpTouchStart);
        bubbleJumpBtn.removeEventListener('touchstart', handleBubbleJumpTouchStart);

        // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        leftBtn.addEventListener('touchstart', handleLeftTouchStart);
        leftBtn.addEventListener('touchend', handleLeftTouchEnd);
        rightBtn.addEventListener('touchstart', handleRightTouchStart);
        rightBtn.addEventListener('touchend', handleRightTouchEnd);
        jumpBtn.addEventListener('touchstart', handleJumpTouchStart);
        bubbleJumpBtn.addEventListener('touchstart', handleBubbleJumpTouchStart);
    }

    function handleLeftTouchStart(e) { e.preventDefault(); if (gameStarted && window.innerWidth > window.innerHeight) baby.dx = -baby.speed; }
    function handleLeftTouchEnd(e) { e.preventDefault(); if (gameStarted) baby.dx = 0; }
    function handleRightTouchStart(e) { e.preventDefault(); if (gameStarted && window.innerWidth > window.innerHeight) baby.dx = baby.speed; }
    function handleRightTouchEnd(e) { e.preventDefault(); if (gameStarted) baby.dx = 0; }
    function handleJumpTouchStart(e) { e.preventDefault(); if (gameStarted && !baby.isJumping && window.innerWidth > window.innerHeight) { baby.dy = baby.jumpPower; baby.isJumping = true; } }
    function handleBubbleJumpTouchStart(e) { e.preventDefault(); if (gameStarted && window.innerWidth > window.innerHeight) bubbleJump(); }


    setupMobileControls();

    document.addEventListener('keydown', e => {
      if (!gameStarted || window.innerWidth < window.innerHeight) return;
      if (e.key === 'ArrowRight') baby.dx = baby.speed;
      if (e.key === 'ArrowLeft') baby.dx = -baby.speed;
      if ((e.key === 'a' || e.key === 'ã…') && !baby.isJumping) {
        baby.dy = baby.jumpPower; baby.isJumping = true;
      }
      if (e.key === ' ') { e.preventDefault(); bubbleJump(); }
    });
    document.addEventListener('keyup', e => {
      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') baby.dx = 0;
    });

    // ëª¨ë“  ê²Œì„ ì´ë¯¸ì§€ ë¡œë”© ëª©ë¡ ì—…ë°ì´íŠ¸
    const allGameImages = [babyImg, platformImg, bubbleImg, goalImg, dragonImg, redDragonImg, goldDragonImg];
    const imagePromises = allGameImages.map(img => new Promise((resolve, reject) => {
        if (img.complete) resolve();
        else { img.onload = resolve; img.onerror = reject; }
    }));
    const audioPromise = new Promise((resolve, reject) => {
        bgm.oncanplaythrough = resolve; bgm.onerror = reject;
    });

    Promise.all(imagePromises,).then(() => {
      startButton.disabled = false; startButton.textContent = 'Start Game';
      checkOrientation(); // ì´ë¯¸ì§€ ë¡œë”© í›„ì—ë„ ë°©í–¥ ì²´í¬
    }).catch(error => {
      startButton.textContent = 'ì—ëŸ¬! ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”'; startButton.style.backgroundColor = 'red';
      console.error("Failed to load game assets:", error);
    });

    window.addEventListener('load', checkOrientation);

  </script>
</body>
</html>