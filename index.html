<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Baby Jumper "Jehee" - Final Version</title>
  <style>
    /* ê¸°ë³¸ ì„¤ì •: bodyì™€ htmlì´ í™”ë©´ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë„ë¡ í•©ë‹ˆë‹¤. */
    body, html {
        margin: 0;
        padding: 0;
        overflow: hidden; /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€: ìš°ë¦¬ê°€ ìŠ¤í¬ë¡¤í•˜ì§€ ì•Šê³  ë ˆì´ì•„ì›ƒìœ¼ë¡œ ì¡°ì ˆí•  ê²ƒ */
        width: 100vw; /* ë·°í¬íŠ¸ ë„ˆë¹„ ì „ì²´ */
        height: 100vh; /* ë·°í¬íŠ¸ ë†’ì´ ì „ì²´ */
        font-family: 'Arial', sans-serif;
        background-color: #d0f4f7; /* ê²Œì„ ë°°ê²½ìƒ‰ */
        
        /* Flexboxë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì²´ ë ˆì´ì•„ì›ƒ (ê²Œì„ì˜ì—­ + ì»¨íŠ¸ë¡¤)ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
        display: flex;
        flex-direction: column; /* ìì‹ ìš”ì†Œë“¤ì„ ì„¸ë¡œë¡œ ì •ë ¬: gameContainer, mobileControls */
        justify-content: flex-start; /* ìƒë‹¨ì—ì„œë¶€í„° ë°°ì¹˜ */
        align-items: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
        position: relative; /* ì„¸ë¡œ ëª¨ë“œ ë©”ì‹œì§€ë¥¼ ìœ„í•œ ê¸°ì¤€ì  */
    }

    /* ì„¸ë¡œ ëª¨ë“œì¼ ë•Œ ì ìš©ë˜ëŠ” ìŠ¤íƒ€ì¼ */
    @media screen and (orientation: portrait) {
        body {
            /* ì„¸ë¡œ ëª¨ë“œ íšŒì „ ë° ìœ„ì¹˜ ì¡°ì • */
            transform: rotate(90deg); 
            transform-origin: bottom left; 
            width: 100vh; 
            height: 100vw; 
            position: absolute;
            top: 100%; 
            left: 0;
            z-index: 9990; 
            background-color: transparent; 
            display: block; /* ë©”ì‹œì§€ë¥¼ ìœ„í•´ blockìœ¼ë¡œ ë³€ê²½ (flexbox í•´ì œ) */
        }

        /* ì„¸ë¡œ ëª¨ë“œì¼ ë•Œ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤„ ë©”ì‹œì§€ (ì¥ì¹˜ë¥¼ íšŒì „í•˜ë¼ëŠ” ì•ˆë‚´) */
        body::before {
            content: "ê¸°ê¸°ë¥¼ ê°€ë¡œ ëª¨ë“œë¡œ íšŒì „í•´ì£¼ì„¸ìš”.";
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9); 
            color: white; 
            display: flex; 
            justify-content: center;
            align-items: center;
            font-size: 24px;
            text-align: center;
            z-index: 9999; 
        }

        /* ì„¸ë¡œ ëª¨ë“œì¼ ë•Œ ëª¨ë“  ê²Œì„ ê´€ë ¨ í™”ë©´ ë° UIë¥¼ ì™„ì „íˆ ìˆ¨ê¹€ */
        #startScreen, #winScreen, #gameOverScreen, #gameContainer, #uiLayer, #mobileControls {
            display: none !important; 
        }
    }

    /* ìƒˆë¡œìš´ ê²Œì„ ì»¨í…Œì´ë„ˆ: ìº”ë²„ìŠ¤ì™€ UIë¥¼ í¬í•¨í•˜ê³  ë¹„ìœ¨ì„ ìœ ì§€ */
    #gameContainer {
        position: relative; /* ë‚´ë¶€ UI ë ˆì´ì–´ì˜ absolute ê¸°ì¤€ì  */
        width: 100%; /* ë¶€ëª¨(body)ì˜ ê°€ë¡œ 100% */
        flex-grow: 1; /* mobileControlsë¥¼ ì œì™¸í•œ ë‚¨ì€ ìˆ˜ì§ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€ */
        display: flex; /* ë‚´ë¶€ ìº”ë²„ìŠ¤ ì¤‘ì•™ ì •ë ¬ìš© */
        justify-content: center; /* ìº”ë²„ìŠ¤ë¥¼ ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
        align-items: center; /* ìº”ë²„ìŠ¤ë¥¼ ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
        background-color: #d0f4f7; /* ê²Œì„ ë°°ê²½ìƒ‰ */

        /* ì´ ì»¨í…Œì´ë„ˆê°€ ì›ë³¸ ê²Œì„ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë„ë¡ max-width/heightë¥¼ ì¡°ì • */
        /* ì›ë³¸ ë¹„ìœ¨ 800:600 = 4:3 */
        /* ì´ ì»¨í…Œì´ë„ˆëŠ” ë·°í¬íŠ¸ í¬ê¸°ì— ë”°ë¼ ìœ ì—°í•˜ê²Œ ìŠ¤ì¼€ì¼ë˜ë„ë¡ í•©ë‹ˆë‹¤. */
        /* ìµœëŒ€ í¬ê¸°ë¥¼ ì œí•œí•˜ì—¬ PC ë“± í° í™”ë©´ì—ì„œ ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒì„ ë°©ì§€ */
        max-width: 800px; /* ì´ ì»¨í…Œì´ë„ˆê°€ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë„ˆë¹„ */
        max-height: 600px; /* ì´ ì»¨í…Œì´ë„ˆê°€ ê°€ì§ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ë†’ì´ */
        /* aspect-ratioë¥¼ ì‚¬ìš©í•˜ë©´ ë”ìš± ê°•ë ¥í•˜ê²Œ ë¹„ìœ¨ì„ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ìµœì‹  ë¸Œë¼ìš°ì € ì§€ì›) */
        /* aspect-ratio: 4 / 3; */ /* ì´ ì†ì„±ì„ ì“°ë©´ ì•„ë˜ min-height ê³„ì‚°ì´ ê°„ë‹¨í•´ì§ */
        /* ë§Œì•½ aspect-ratioë¥¼ ì‚¬ìš©í•œë‹¤ë©´ min-width/heightëŠ” ë³´í†µ í•„ìš” ì—†ìŒ */
    }

    canvas {
        display: block;
        width: 100%; /* gameContainer ë‚´ì—ì„œ ê°€ë¡œ 100% */
        height: 100%; /* gameContainer ë‚´ì—ì„œ ì„¸ë¡œ 100% */
        /* ìº”ë²„ìŠ¤ ìì²´ì˜ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©° ì»¨í…Œì´ë„ˆì— ë§ì¶¤ (JSì—ì„œ ì¡°ì ˆ) */
        /* CSSì˜ object-fit: containì€ ìº”ë²„ìŠ¤ ë‚´ë¶€ ê·¸ë¦¼ë³´ë‹¤ëŠ” ì—˜ë¦¬ë¨¼íŠ¸ ìì²´ì— ì£¼ë¡œ ì ìš©ë¨ */
    }

    /* UI ë ˆì´ì–´ (ì ìˆ˜, ë¼ì´í”„ ë“±): gameContainer ë‚´ì—ì„œ absolute */
    #uiLayer {
      position: absolute; /* gameContainer ê¸°ì¤€ */
      /* ìŠ¤ì¼€ì¼ë§ëœ ìº”ë²„ìŠ¤ì— ë§ì¶° ìœ„ì¹˜ì™€ í¬ê¸° ì¡°ì • (JSì—ì„œ ìŠ¤ì¼€ì¼ë§) */
      top: 0; left: 0; /* ìº”ë²„ìŠ¤ ìƒë‹¨ì— ì •ë ¬ */
      width: 100%; /* ìº”ë²„ìŠ¤ ë„ˆë¹„ì— ë§ì¶° */
      height: 100%; /* ìº”ë²„ìŠ¤ ë†’ì´ì— ë§ì¶° */
      display: flex; 
      flex-direction: column; /* ë‚´ìš©ì„ ì„¸ë¡œë¡œ ë°°ì¹˜ */
      justify-content: flex-start; /* ìƒë‹¨ ì •ë ¬ */
      pointer-events: none; /* UI ìš”ì†Œ í´ë¦­ ë°©ì§€ */
      z-index: 50; 
      padding: 10px; /* ë‚´ë¶€ ì—¬ë°± */
      box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
    }
    #uiLayer > div:first-child { /* #stats */
        display: flex; 
        justify-content: space-between; 
        width: 100%;
        margin-bottom: auto; /* í•˜ë‹¨ìœ¼ë¡œ ë°€ì–´ëƒ„ */
    }
    #uiLayer > div:last-child { /* #bubbleGauge */
        display: flex;
        justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
        width: 100%;
        margin-top: auto; /* ìƒë‹¨ìœ¼ë¡œ ë°€ì–´ëƒ„ */
    }
    #stats { display: flex; gap: 20px; } /* ì™¼ìª½ ìŠ¤íƒ¯ ê·¸ë£¹ */
    #bubbleGauge { display: flex; gap: 5px; align-items: center; } /* ì˜¤ë¥¸ìª½ ë²„ë¸” ê·¸ë£¹ */
    .bubble-icon { width: 30px; height: 30px; opacity: 1; transition: opacity 0.2s; }
    .bubble-icon.empty { opacity: 0.2; }
    #score { 
        position: absolute; 
        top: 10px; 
        left: 50%; 
        transform: translateX(-50%); /* ì¤‘ì•™ ì •ë ¬ */
        color: #0b3c5d; 
        font-size: 24px; 
        font-weight: bold;
    }


    /* ì‹œì‘/ì¢…ë£Œ/ìŠ¹ë¦¬ í™”ë©´ ì»¨í…Œì´ë„ˆ */
    #startScreen, #winScreen, #gameOverScreen {
      position: absolute; /* body ê¸°ì¤€ */
      top: 0; left: 0;
      width: 100vw; height: 100vh; /* ë·°í¬íŠ¸ ì „ì²´ ì°¨ì§€ */
      background: linear-gradient(to bottom, #a8e0f7, #d9f7fc);
      display: flex; 
      flex-direction: column; /* ë‚´ë¶€ ìš”ì†Œ ì„¸ë¡œ ì •ë ¬ */
      align-items: center; 
      justify-content: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
      z-index: 100; /* ê²Œì„ ìœ„ë¡œ ì˜¬ë¼ì˜¤ë„ë¡ */
      text-align: center;
      box-sizing: border-box; /* íŒ¨ë”© í¬í•¨ í¬ê¸° ê³„ì‚° */
      /* ì•„ë˜ íŒ¨ë”©ì„ ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ë†’ì´ë§Œí¼ ì¤˜ì„œ ì‹œì‘ ë²„íŠ¼ì´ ì»¨íŠ¸ë¡¤ ìœ„ì— ì˜¤ë„ë¡ */
      padding-bottom: 120px; /* #mobileControlsì˜ ì˜ˆìƒ ë†’ì´ + í•˜ë‹¨ ì—¬ë°± */
    }
    #gameOverScreen { background: linear-gradient(to bottom, #5c5c5c, #333333); }
    #startScreen h1, #winScreen h1, #gameOverScreen h1 { 
        font-size: 64px; color: #ff9f1c; margin-bottom: 20px; 
    }
    #gameOverScreen h1 { color: #ff4d6d; }
    #startScreen p, #winScreen p, #gameOverScreen p { 
        font-size: 20px; color: #3282b8; margin-bottom: 30px; 
    }
    #gameOverScreen p { color: #cccccc; }
    #startButton, #restartButton, #restartButtonGO {
      padding: 15px 40px; font-size: 24px;
      background-color: #ff9f1c; color: white;
      border: 2px solid #e68a00; border-radius: 12px; cursor: pointer;
      box-shadow: 0 4px #e68a00;
      margin-top: auto; /* startScreenì˜ flex container ë‚´ì—ì„œ ë²„íŠ¼ì„ í•˜ë‹¨ìœ¼ë¡œ ë°€ì–´ëƒ„ */
    }
    .rankingList {
      font-size: 18px; color: #333; margin: 20px 0; text-align: left;
      background: white; padding: 15px; border-radius: 10px; width: 300px;
    }
    .rankingList h3 { margin-top: 0; text-align: center;}

    /* [ëª¨ë°”ì¼] í„°ì¹˜ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #mobileControls {
        flex-shrink: 0; /* ì»¨íŠ¸ë¡¤ ì»¨í…Œì´ë„ˆê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ í•¨ */
        width: 100%;
        min-height: 100px; /* ì»¨íŠ¸ë¡¤ì˜ ìµœì†Œ ë†’ì´ (ë²„íŠ¼ í¬ê¸° ê³ ë ¤) */
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-sizing: border-box;
        padding: 15px 20px; 
        z-index: 20;
        user-select: none;
        background-color: rgba(0, 0, 0, 0.1); 
        padding-bottom: calc(15px + env(safe-area-inset-bottom)); 
    }
    #mobileControls > div {
        display: flex;
        gap: 20px;
    }
    #leftBtn, #rightBtn, #jumpBtn, #bubbleJumpBtn {
        width: 10vh; 
        height: 10vh;
        max-width: 70px; 
        max-height: 70px;
        background-color: rgba(255, 159, 28, 0.7);
        color: white;
        font-size: 24px;
        font-weight: bold;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 50%;
        border: 3px solid rgba(230, 138, 0, 0.9);
        box-shadow: 0 4px rgba(230, 138, 0, 0.9);
    }
    #actionBtns {
        display: flex;
        gap: 20px;
    }
  </style>
</head>
<body>
  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <div id="uiLayer">
      <div>
        <div id="stats">
          <div id="livesDisplay">â¤ï¸ 3</div>
          <div id="timerDisplay">â° 20</div>
        </div>
        <div id="score">Score: 0</div>
      </div>
      <div>
        <div id="bubbleGauge"></div>
      </div>
    </div>
  </div>

  <div id="startScreen">
    <h1>Baby Jumper "Jehee"</h1>
    <p>5ê°œì˜ ë²„ë¸”ë¡œ 10ê°œì˜ ìŠ¤í…Œì´ì§€ë¥¼ ì •ë³µí•˜ì„¸ìš”!</p>
    <p><strong>Controls:</strong> â† â†’ to move, A to Jump, SPACE to Bubble Jump</p>
    <button id="startButton" disabled>ê²Œì„ ë¡œë”©ì¤‘...</button>
  </div>

  <div id="winScreen" style="display: none;">
    <h1>CONGRATULATIONS!</h1>
    <p>ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤!</p>
    <div id="rankingList" class="rankingList"></div>
    <button id="restartButton">Play Again</button>
  </div>

  <div id="gameOverScreen" style="display: none;">
    <h1>GAME OVER</h1>
    <div id="rankingListGO" class="rankingList"></div>
    <button id="restartButtonGO">Try Again</button>
  </div>

  <audio id="bgm" src="./bgm.mp3" loop></audio>

  <div id="mobileControls" style="display: none;">
    <div id="leftBtn">â†</div>
    <div id="rightBtn">â†’</div>
    <div id="actionBtns">
      <div id="bubbleJumpBtn">BUBBLE</div>
      <div id="jumpBtn">JUMP</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const originalDesignWidth = 800; 
    const originalDesignHeight = 600; 

    function resizeCanvasAndGame() {
        const gameContainer = document.getElementById('gameContainer');
        const displayWidth = gameContainer.clientWidth; 
        const displayHeight = gameContainer.clientHeight; 

        // ê²Œì„ì˜ ì›ë³¸ ë¹„ìœ¨ (4:3)
        const aspectRatio = originalDesignWidth / originalDesignHeight;

        let targetWidth = displayWidth;
        let targetHeight = displayHeight;

        // gameContainerê°€ ê°€ì§„ ê³µê°„ì— ë§ì¶° ì›ë³¸ ë¹„ìœ¨ ìœ ì§€
        if (targetWidth / targetHeight > aspectRatio) {
            // í™”ë©´ì´ ì›ë³¸ë³´ë‹¤ ê°€ë¡œê°€ ê¸¸ë‹¤ -> ë†’ì´ì— ë§ì¶° ë„ˆë¹„ ì¡°ì ˆ
            targetWidth = targetHeight * aspectRatio;
        } else {
            // í™”ë©´ì´ ì›ë³¸ë³´ë‹¤ ì„¸ë¡œê°€ ê¸¸ë‹¤ -> ë„ˆë¹„ì— ë§ì¶° ë†’ì´ ì¡°ì ˆ
            targetHeight = targetWidth / aspectRatio;
        }

        // ìº”ë²„ìŠ¤ ì—˜ë¦¬ë¨¼íŠ¸ì˜ í¬ê¸°ë¥¼ ì¡°ì ˆ (CSSì™€ ë™ê¸°í™”)
        canvas.style.width = targetWidth + 'px';
        canvas.style.height = targetHeight + 'px';

        // ìº”ë²„ìŠ¤ ìì²´ì˜ ë‚´ë¶€ ë“œë¡œì‰ ë²„í¼ í¬ê¸°ë¥¼ ì¡°ì ˆ (ì„ ëª…ë„ë¥¼ ìœ„í•´)
        if (canvas.width !== targetWidth || canvas.height !== targetHeight) {
            canvas.width = targetWidth;
            canvas.height = targetHeight;
        }

        // ì»¨í…ìŠ¤íŠ¸ì— ìŠ¤ì¼€ì¼ ë³€í™˜ ì ìš©
        const scaleX = targetWidth / originalDesignWidth;
        const scaleY = targetHeight / originalDesignHeight;
        const scale = Math.min(scaleX, scaleY); 
        ctx.setTransform(scale, 0, 0, scale, 0, 0);

        // UI Layerë„ ìº”ë²„ìŠ¤ í¬ê¸°ì— ë§ì¶° ìŠ¤ì¼€ì¼ ë° ìœ„ì¹˜ ì¡°ì • (CSSë¡œ ì²˜ë¦¬í•˜ê¸° ìœ„í•¨)
        const uiLayer = document.getElementById('uiLayer');
        uiLayer.style.width = targetWidth + 'px';
        uiLayer.style.height = targetHeight + 'px'; // uiLayerë„ ìº”ë²„ìŠ¤ í¬ê¸°ë§Œí¼ ì°¨ì§€
        // uiLayerì˜ left/topì€ position: absolute; top:0; left:0; ë¡œ gameContainer ê¸°ì¤€

        // Score í…ìŠ¤íŠ¸ì˜ ì¤‘ì•™ ìœ„ì¹˜ ì¡°ì • (uiLayerê°€ ìŠ¤ì¼€ì¼ë  ë•Œ)
        const scoreElement = document.getElementById('score');
        scoreElement.style.fontSize = (24 * scale) + 'px'; // ìŠ¤ì¼€ì¼ì— ë§ì¶° í°íŠ¸ í¬ê¸° ì¡°ì •
        // ì´ë¯¸ CSSì—ì„œ translateX(-50%)ë¡œ ì¤‘ì•™ ì •ë ¬ë˜ê³  ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” í°íŠ¸ í¬ê¸°ë§Œ ì¡°ì •
    }

    window.addEventListener('resize', resizeCanvasAndGame);
    window.addEventListener('orientationchange', resizeCanvasAndGame);

    const worldHeight = originalDesignHeight * 2; 
    const camera = {
      y: worldHeight - originalDesignHeight, 
      lerpFactor: 0.08
    };

    const babyImg = new Image(); babyImg.src = "./baby.png";
    const platformImg = new Image(); platformImg.src = "./platform.png";
    const bubbleImg = new Image(); bubbleImg.src = "./bubble.png";
    const goalImg = new Image(); goalImg.src = "./milk.png";
    const dragonImg = new Image(); dragonImg.src = "./dragon.png";
    const bgm = document.getElementById('bgm');

    let gameStarted = false, score = 0;
    let currentStage = 1;
    const totalStages = 10;
    let stageTimer = 20;
    let lastTime = 0, deltaTime = 0;

    const baby = {
      x: originalDesignWidth / 2 - 25, y: worldHeight - 80,
      width: 50, height: 50, speed: 4,
      dx: 0, dy: 0, gravity: 0.4, jumpPower: -10,
      isJumping: false, bubblesLeft: 5, maxBubbles: 5, bubbleJumpPower: -12,
      lives: 3
    };
    const platforms = [], bubbles = [], enemies = [];
    const goal = { x: originalDesignWidth / 2 - 20, y: 50, width: 40, height: 40 };

    const stageConfigs = [
        { stage: 1, normal: 0, fast: 0, jumper: 0 }, { stage: 2, normal: 1, fast: 0, jumper: 0 },
        { stage: 3, normal: 2, fast: 0, jumper: 0 }, { stage: 4, normal: 3, fast: 0, jumper: 0 },
        { stage: 5, normal: 4, fast: 0, jumper: 0 }, { stage: 6, normal: 3, fast: 2, jumper: 0 },
        { stage: 7, normal: 3, fast: 2, jumper: 1 }, { stage: 8, normal: 7, fast: 2, jumper: 1 },
        { stage: 9, normal: 6, fast: 4, jumper: 2 }, { stage: 10, normal: 4, fast: 8, jumper: 3 }
    ];

    const startButton = document.getElementById('startButton');
    const restartButton = document.getElementById('restartButton');
    const restartButtonGO = document.getElementById('restartButtonGO');
    const startScreen = document.getElementById('startScreen');
    const winScreen = document.getElementById('winScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const scoreText = document.getElementById('score');
    const bubbleGauge = document.getElementById('bubbleGauge');
    const livesDisplay = document.getElementById('livesDisplay');
    const timerDisplay = document.getElementById('timerDisplay');
    const rankingList = document.getElementById('rankingList');
    const rankingListGO = document.getElementById('rankingListGO');

    function generateLevel() {
      platforms.length = 0; enemies.length = 0;
      platforms.push({ x: 0, y: worldHeight - 20, width: originalDesignWidth });
      let currentY = worldHeight - 100;
      while (currentY > 100) {
        let pWidth = 100 + Math.random() * 50;
        let pX = Math.random() * (originalDesignWidth - pWidth);
        platforms.push({ x: pX, y: currentY, width: pWidth });
        currentY -= 70 + Math.random() * 50;
      }
      const config = stageConfigs[currentStage - 1];
      if (!config) return;
      const spawnPlatforms = [...platforms].slice(1);
      spawnPlatforms.sort(() => 0.5 - Math.random());
      let platformIndex = 0;
      const createEnemy = (type) => {
          if (spawnPlatforms.length === 0) return;
          const platform = spawnPlatforms[platformIndex % spawnPlatforms.length];
          platformIndex++;
          const enemyData = {
              x: platform.x + platform.width / 2 - 17, y: platform.y - 35, width: 35, height: 35,
              direction: Math.random() < 0.5 ? 1 : -1, type: type,
              speed: 1 + Math.random() * currentStage * 0.15,
              dy: 0, groundY: platform.y - 35, jumpPower: -7 - Math.random() * 2,
          };
          if (type === 'fast') { enemyData.speed *= 2; }
          if (type === 'jumper') { enemyData.speed = 0; }
          enemies.push(enemyData);
      };
      for(let i=0; i<config.normal; i++) createEnemy('normal');
      for(let i=0; i<config.fast; i++) createEnemy('fast');
      for(let i=0; i<config.jumper; i++) createEnemy('jumper');
      const topPlatform = platforms.reduce((prev, curr) => (curr.y < prev.y ? curr : prev), platforms[0]);
      goal.x = topPlatform.x + (topPlatform.width / 2) - (goal.width / 2);
      goal.y = topPlatform.y - goal.height - 15;
    }

    function startGame() {
      startScreen.style.display = 'none';
      winScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';
      gameStarted = true; score = 0; currentStage = 1; baby.lives = 3;
      generateLevel();
      resetPlayerPosition();
      bgm.currentTime = 0; 
      bgm.play().catch(e => {
        console.log("BGM ì¬ìƒ ì˜¤ë¥˜ (ëª¨ë°”ì¼ ìë™ ì¬ìƒ ì •ì±… ë“±):", e);
      });
      update();
    }
    startButton.addEventListener('click', startGame);
    restartButton.addEventListener('click', startGame);
    restartButtonGO.addEventListener('click', startGame);

    function resetPlayerPosition() {
        stageTimer = 20; baby.x = originalDesignWidth / 2 - 25; baby.y = worldHeight - 80;
        baby.dy = 0; camera.y = worldHeight - originalDesignHeight; 
        baby.bubblesLeft = baby.maxBubbles;
    }

    function handleLoseLife() {
        baby.lives--;
        if (baby.lives <= 0) {
            showGameOver();
        } else {
            resetPlayerPosition();
        }
    }

    function updateAndShowRanking(playerName, targetElement) {
        let scores = JSON.parse(localStorage.getItem('babyJumperScores')) || [];
        scores.push({ name: playerName, score: score });
        scores.sort((a, b) => b.score - a.score);
        scores = scores.slice(0, 5);
        localStorage.setItem('babyJumperScores', JSON.stringify(scores));
        let rankingHtml = '<h3>ğŸ† Top 5 Scores ğŸ†</h3><ol>';
        rankingHtml += scores.map(s => `<li>${s.name}: ${s.score}</li>`).join('');
        rankingHtml += '</ol>';
        targetElement.innerHTML = rankingHtml;
    }

    function showGameOver() {
        gameStarted = false;
        bgm.pause();
        const playerName = prompt(`GAME OVER!\nYour Score: ${score}\n\nEnter your name for the ranking:`, "AAA");
        updateAndShowRanking(playerName || "Guest", rankingListGO);
        gameOverScreen.style.display = 'flex';
    }

    function advanceToNextStage() {
        currentStage++;
        if (currentStage > totalStages) {
            showWinScreen();
        } else {
            score += Math.ceil(stageTimer * 10);
            generateLevel();
            resetPlayerPosition();
        }
    }

    function showWinScreen() {
        gameStarted = false;
        bgm.pause();
        const playerName = prompt(`CONGRATULATIONS!\nYour Final Score: ${score}\n\nEnter your name for the ranking:`, "ACE");
        updateAndShowRanking(playerName || "Guest", rankingList);
        winScreen.style.display = 'flex';
    }

    function bubbleJump() {
      if (baby.bubblesLeft > 0 && gameStarted) {
        baby.bubblesLeft--; baby.dy = baby.bubbleJumpPower;
        bubbles.push({x: baby.x + baby.width / 2, y: baby.y + baby.height, radius: 15, life: 30});
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); 
      ctx.save();
      ctx.translate(0, -camera.y); 

      platforms.forEach(p => ctx.drawImage(platformImg, p.x, p.y, p.width, 20));
      ctx.filter = 'sepia(1) saturate(10) hue-rotate(-50deg) brightness(1.1)';
      ctx.drawImage(goalImg, goal.x, goal.y, goal.width, goal.height);
      ctx.filter = 'none';
      enemies.forEach(e => ctx.drawImage(dragonImg, e.x, e.y, e.width, e.height));
      ctx.drawImage(babyImg, baby.x, baby.y, baby.width, baby.height);
      bubbles.forEach((b, index) => {
        b.y += 2; b.radius *= 0.95; b.life--;
        ctx.globalAlpha = b.life / 30;
        ctx.drawImage(bubbleImg, b.x - b.radius, b.y - b.radius, b.radius * 2, b.radius * 2);
        if (b.life <= 0) bubbles.splice(index, 1);
      });
      ctx.globalAlpha = 1;
      ctx.restore();
    }

    function drawUI() {
        // UI í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì •
        const currentScale = canvas.clientWidth / originalDesignWidth;
        scoreText.style.fontSize = (24 * currentScale) + 'px';
        livesDisplay.style.fontSize = (24 * currentScale) + 'px';
        timerDisplay.style.fontSize = (24 * currentScale) + 'px';
        
        // ë²„ë¸” ì•„ì´ì½˜ í¬ê¸° ì¡°ì •
        Array.from(bubbleGauge.children).forEach(img => {
            img.style.width = (30 * currentScale) + 'px';
            img.style.height = (30 * currentScale) + 'px';
        });

        scoreText.textContent = `Stage ${currentStage} | Score: ${score}`;
        livesDisplay.textContent = 'â¤ï¸ ' + baby.lives;
        timerDisplay.textContent = 'â° ' + Math.ceil(stageTimer);
        bubbleGauge.innerHTML = '';
        for(let i = 0; i < baby.maxBubbles; i++) {
            const img = document.createElement('img');
            img.src = './bubble.png';
            img.className = 'bubble-icon';
            if (i >= baby.bubblesLeft) img.classList.add('empty');
            bubbleGauge.appendChild(img);
        }
    }

    function update(time = 0) {
      if (!gameStarted) return;
      deltaTime = (time - lastTime) / 1000; lastTime = time;
      stageTimer -= deltaTime;
      if (stageTimer <= 0) { handleLoseLife(); }
      baby.x += baby.dx; baby.dy += baby.gravity; baby.y += baby.dy;
      
      const cameraTargetY = baby.y - originalDesignHeight / 2; 
      camera.y += (cameraTargetY - camera.y) * camera.lerpFactor;
      if (camera.y < 0) camera.y = 0;
      if (camera.y > worldHeight - originalDesignHeight) { camera.y = worldHeight - originalDesignHeight; }
      
      if (baby.dy > 0) {
        platforms.forEach(p => {
          if (baby.x + baby.width > p.x && baby.x < p.x + p.width &&
              baby.y + baby.height > p.y && baby.y < p.y + 20) {
            baby.y = p.y - baby.height; baby.dy = 0; baby.isJumping = false;
          }
        });
      }
      enemies.forEach(e => {
        switch(e.type) {
            case 'normal': case 'fast':
                e.x += e.speed * e.direction;
                if(e.x < 0 || e.x + e.width > originalDesignWidth) e.direction *= -1; 
                break;
            case 'jumper':
                e.dy += baby.gravity * 0.5; e.y += e.dy;
                if (e.y > e.groundY && e.dy > 0) { e.y = e.groundY; e.dy = e.jumpPower; }
                break;
        }
        if (baby.x < e.x + e.width && baby.x + baby.width > e.x &&
            baby.y < e.y + e.height && baby.y + baby.height > e.y) {
            handleLoseLife();
        }
      });
      if (baby.x < 0) baby.x = 0;
      if (baby.x + baby.width > originalDesignWidth) baby.x = originalDesignWidth - baby.width;
      
      if (baby.y > worldHeight) { handleLoseLife(); }
      if (baby.y + baby.height < 0) { baby.y = -baby.height; baby.dy = 1; }
      if (baby.x < goal.x + goal.width && baby.x + baby.width > goal.x &&
          baby.y < goal.y + goal.height && baby.y + baby.height > goal.y) {
        advanceToNextStage();
      }
      draw();
      drawUI();
      requestAnimationFrame(update);
    }

    // [ëª¨ë°”ì¼] í„°ì¹˜ ì»¨íŠ¸ë¡¤ëŸ¬ ë¡œì§
    function setupMobileControls() {
        const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        if (!isMobile) {
            document.getElementById('mobileControls').style.display = 'none'; 
            return;
        }
        document.getElementById('mobileControls').style.display = 'flex'; 
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');
        const jumpBtn = document.getElementById('jumpBtn');
        const bubbleJumpBtn = document.getElementById('bubbleJumpBtn');
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); if (gameStarted) baby.dx = -baby.speed;
        });
        leftBtn.addEventListener('touchend', (e) => {
            e.preventDefault(); if (gameStarted) baby.dx = 0;
        });
        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); if (gameStarted) baby.dx = baby.speed;
        });
        rightBtn.addEventListener('touchend', (e) => {
            e.preventDefault(); if (gameStarted) baby.dx = 0;
        });
        jumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameStarted && !baby.isJumping) {
                baby.dy = baby.jumpPower; baby.isJumping = true;
            }
        });
        bubbleJumpBtn.addEventListener('touchstart', (e) => {
            e.preventDefault(); if (gameStarted) bubbleJump();
        });
    }

    // í‚¤ë³´ë“œ ì…ë ¥
    document.addEventListener('keydown', e => {
      if (!gameStarted) return;
      if (e.key === 'ArrowRight') baby.dx = baby.speed;
      if (e.key === 'ArrowLeft') baby.dx = -baby.speed;
      if ((e.key === 'a' || e.key === 'ã…') && !baby.isJumping) {
        baby.dy = baby.jumpPower; baby.isJumping = true;
      }
      if (e.key === ' ') { e.preventDefault(); bubbleJump(); }
    });
    document.addEventListener('keyup', e => {
      if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') baby.dx = 0;
    });

    // ê²Œì„ ë¦¬ì†ŒìŠ¤ ë¡œë”©
    const allGameImages = [babyImg, platformImg, bubbleImg, goalImg, dragonImg];
    const imagePromises = allGameImages.map(img => new Promise((resolve, reject) => {
        if (img.complete) resolve();
        else { img.onload = resolve; img.onerror = reject; }
    }));
    
    bgm.oncanplaythrough = () => {
        console.log("BGM ë¡œë“œ ì™„ë£Œ.");
    };
    bgm.onerror = (e) => {
        console.error("BGM ë¡œë“œ ì˜¤ë¥˜:", e);
    };

    // ì´ë¯¸ì§€ ë¦¬ì†ŒìŠ¤ ë¡œë”©ì´ ëª¨ë‘ ì™„ë£Œë˜ë©´ ê²Œì„ ì‹œì‘ ë²„íŠ¼ í™œì„±í™” ë° ì´ˆê¸°í™” í•¨ìˆ˜ í˜¸ì¶œ
    Promise.all(imagePromises).then(() => {
      startButton.disabled = false;
      startButton.textContent = 'Start Game';
      
      resizeCanvasAndGame(); 
      setupMobileControls();
    }).catch(error => {
      startButton.textContent = 'ì—ëŸ¬! ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”'; 
      startButton.style.backgroundColor = 'red';
      console.error("ë¦¬ì†ŒìŠ¤ ë¡œë”© ì˜¤ë¥˜:", error);
    });
  </script>
</body>
</html>